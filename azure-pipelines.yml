# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master
stages:
  - stage: Build
    jobs:
      - job: BuildwebApp
        pool:
          name: Azure Pipelines
          demands:
          - msbuild
          - visualstudio
          - vstest
        variables:
          solution: '**/*.sln'
          buildPlatform: 'Any CPU'
          buildConfiguration: 'Release'
        steps:
        - task: NuGetToolInstaller@0
          displayName: 'Use NuGet 4.4.1'
          inputs:
            versionSpec: 4.4.1

        - task: NuGetCommand@2
          displayName: 'NuGet restore'
          inputs:
            restoreSolution: '$(Parameters.solution)'

        - task: VSBuild@1
          displayName: 'Build solution'
          inputs:
            solution: '$(Parameters.solution)'
            msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(build.artifactstagingdirectory)\\"'
            platform: '$(BuildPlatform)'
            configuration: '$(BuildConfiguration)'

        - task: VSTest@2
          displayName: 'Test Assemblies'
          inputs:
            testAssemblyVer2: |
              **\$(BuildConfiguration)\*test*.dll
              !**\obj\**
            platform: '$(BuildPlatform)'
            configuration: '$(BuildConfiguration)'
        
        - task: PublishSymbols@2
          displayName: 'Publish symbols path'
          inputs:
            SearchPattern: '**\bin\**\*.pdb'
            PublishSymbols: false
          continueOnError: true

        - task: PublishBuildArtifacts@1
          displayName: 'Publish Artifact'
          inputs:
            PathtoPublish: '$(build.artifactstagingdirectory)'
            ArtifactName: '$(Parameters.ArtifactName)'
          condition: succeededOrFailed() 

  - stage:  DeployDev
       displayname:'Deploy To Dev'
    jobs:
    - deployment: 
      pool:
          name: Azure Pipelines
          demands:
          - msbuild
          - visualstudio
          - vstest
      environment: 'Dev'
      strategy:
        runOnce:
          deploy:
            steps:
              - task: AzureRmWebAppDeployment@4
                inputs:
                  ConnectionType: 'AzureRM'
                  azureSubscription: 'Free Trial(6b0f29ec-b23a-4145-8315-13ff7a5d7ca9)'
                  appType: 'webApp'
                  WebAppName: 'demowebapppa'
                  packageForLinux: '$(System.DefaultWorkingDirectory)/**/*.zip'

